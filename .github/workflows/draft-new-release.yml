name: Draft new release

on:
  workflow_dispatch:

jobs:
  draft-new-release:
    permissions:
      contents: read # only for checkout, all writes use App Token
    name: Draft a new release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/hotfix/')
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PRIVATE_KEY }}
          permission-contents: write # to create commits, tags, and releases
          permission-pull-requests: write # to create release PRs

      - name: Checkout source branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          token: ${{ steps.generate-token.outputs.token }} # use App Token, don't mix with GITHUB_TOKEN

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      # Calculate the next release version based on conventional semantic release
      - name: Calculate release version and create branch
        id: create-release
        env:
          HUSKY: 0
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          source_branch_name=${GITHUB_REF##*/}
          release_type=release
          grep -q "hotfix/" <<< "${GITHUB_REF}" && release_type=hotfix-release
          git fetch origin master
          git fetch --tags origin
          git merge origin/master
          current_version=$(jq -r .version package.json)

          npx standard-version --skip.commit --skip.tag --skip.changelog
          new_version=$(jq -r .version package.json)
          git reset --hard

          branch_name="${release_type}/${new_version}"

          echo "Source branch for new release is $source_branch_name"
          echo "Current version is $current_version"
          echo "Release type is $release_type"
          echo "New version is $new_version"
          echo "New release branch name is $branch_name"

          # Create release branch via GitHub API (not git push)
          BASE_SHA=$(git rev-parse HEAD)
          gh api repos/${{ github.repository }}/git/refs \
            --method POST \
            -f ref="refs/heads/$branch_name" \
            -f sha="$BASE_SHA"

          echo "source_branch_name=$source_branch_name" >> $GITHUB_OUTPUT
          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT
          echo "new_version=$new_version" >> $GITHUB_OUTPUT
          echo "CURRENT_VERSION_VALUE=$current_version" >> $GITHUB_ENV
          echo "NEW_VERSION_VALUE=$new_version" >> $GITHUB_ENV

      - name: Update changelog & bump version
        id: finish-release
        env:
          HUSKY: 0
        run: |
          echo "Current version: $CURRENT_VERSION_VALUE"
          echo "New version: $NEW_VERSION_VALUE"
          npx replace $CURRENT_VERSION_VALUE $NEW_VERSION_VALUE sonar-project.properties
          npx standard-version -a --skip.commit --skip.tag

      - name: Commit and push changes via GitHub API (verified commit)
        uses: ryancyq/github-signed-commit@e9f3b28c80da7be66d24b8f501a5abe82a6b855f # v1.2.0
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        with:
          branch-name: ${{ steps.create-release.outputs.branch_name }}
          files: |
            CHANGELOG.md
            package.json
            sonar-project.properties
          commit-message: "chore(release): ${{ steps.create-release.outputs.new_version }}"

      - name: Create pull request into master
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          pr_title="chore(release): merge ${{ steps.create-release.outputs.branch_name }} into master"
          
          # Create PR body with proper formatting
          cat > pr_body.md << EOF
          :crown: **Automated Release PR**

          This pull request was created automatically by the GitHub Actions workflow. It merges the release branch (\`${{ steps.create-release.outputs.branch_name }}\`) into the \`master\` branch.

          This ensures that the latest release branch changes are incorporated into the \`master\` branch for production.

          ### Details
          - **Release Version**: v${{ env.NEW_VERSION_VALUE }}
          - **Release Branch**: \`${{ steps.create-release.outputs.branch_name }}\`

          ---
          Please review and merge when ready. :rocket:
          EOF
          
          # Create the PR using GitHub CLI
          gh pr create \
            --base master \
            --head ${{ steps.create-release.outputs.branch_name }} \
            --title "$pr_title" \
            --body-file pr_body.md
